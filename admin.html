<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StyleHub 後台管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8f9fa;
        }
        .modal {
            display: none;
            transition: opacity 0.3s ease;
        }
        .modal.is-open {
            display: flex;
        }
        /* 圖片預覽 Modal 的樣式 */
        .thumbnail-active {
            border-color: #4f46e5; /* indigo-600 */
            outline: 2px solid #4f46e5;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-gray-800">
                <a href="#">Style<span class="text-indigo-600">Hub</span> 後台</a>
            </div>
             <a href="index.html" target="_blank" class="text-blue-600 hover:text-blue-800 font-semibold">
                <i class="fas fa-store mr-1"></i>前往前台網站
            </a>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-12">

        <!-- 後台管理 Section -->
        <section id="admin-panel" class="bg-white p-8 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-3xl font-bold mb-6 border-b pb-4">商品管理系統</h2>

            <!-- 新增商品表單 -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4">新增商品</h3>
                <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="text" id="product-name" placeholder="商品名稱" class="p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    <input type="text" id="product-sku" placeholder="商品編號 (SKU)" class="p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    <input type="number" id="product-price" placeholder="價格" class="p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    <input type="number" id="product-stock" placeholder="庫存數量" class="p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    <textarea id="product-image-urls" placeholder="圖片網址 (一行一個)" class="p-3 border rounded-lg col-span-1 md:col-span-2 h-24 focus:ring-2 focus:ring-indigo-500"></textarea>
                    <textarea id="product-description" placeholder="商品描述" class="p-3 border rounded-lg col-span-1 md:col-span-2 h-24 focus:ring-2 focus:ring-indigo-500"></textarea>
                    <div class="col-span-1 md:col-span-2 flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="product-is-featured" class="h-5 w-5 text-indigo-600 rounded">
                            <span class="ml-2 text-gray-700">設為熱門商品</span>
                        </label>
                    </div>
                    <div class="col-span-1 md:col-span-2">
                         <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-300">
                            <i class="fas fa-plus mr-2"></i>確認新增
                        </button>
                    </div>
                </form>
            </div>

            <!-- 商品管理列表 -->
            <div>
                <h3 class="text-xl font-semibold mb-4">管理現有商品</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4">商品</th>
                                <th class="p-4">SKU</th>
                                <th class="p-4">價格</th>
                                <th class="p-4">庫存</th>
                                <th class="p-4">狀態</th>
                                <th class="p-4 text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="admin-product-list">
                            <!-- Admin product list will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <!-- 修改商品 Modal -->
    <div id="edit-modal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6">修改商品資訊</h3>
            <form id="edit-product-form">
                <input type="hidden" id="edit-product-id">
                <div class="space-y-4">
                     <input type="text" id="edit-product-name" placeholder="商品名稱" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                     <input type="text" id="edit-product-sku" placeholder="商品編號 (SKU)" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                     <input type="number" id="edit-product-price" placeholder="價格" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                     <input type="number" id="edit-product-stock" placeholder="庫存數量" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                     <textarea id="edit-product-image-urls" placeholder="圖片網址 (一行一個)" class="w-full p-3 border rounded-lg h-24 focus:ring-2 focus:ring-indigo-500"></textarea>
                     <textarea id="edit-product-description" placeholder="商品描述" class="w-full p-3 border rounded-lg h-24 focus:ring-2 focus:ring-indigo-500"></textarea>
                     <label class="flex items-center">
                         <input type="checkbox" id="edit-product-is-featured" class="h-5 w-5 text-indigo-600 rounded">
                         <span class="ml-2 text-gray-700">設為熱門商品</span>
                     </label>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="cancel-edit" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">儲存變更</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 商品圖片預覽 Modal -->
    <div id="image-preview-modal" class="modal fixed inset-0 bg-black bg-opacity-70 justify-center items-center z-50">
        <div class="bg-white rounded-lg shadow-xl m-4 max-w-2xl w-full relative">
            <button id="preview-modal-close-button" class="absolute -top-3 -right-3 bg-white text-gray-700 w-8 h-8 rounded-full flex items-center justify-center shadow-lg hover:bg-gray-200 focus:outline-none z-10">
                <i class="fas fa-times"></i>
            </button>
            <div class="p-6">
                <h3 id="preview-modal-product-name" class="text-xl font-bold text-gray-800 mb-4"></h3>
                <img id="preview-modal-main-image" src="" alt="Product Detail" class="w-full h-auto max-h-[60vh] object-contain rounded-md bg-gray-100 mb-4" onerror="this.src='https://placehold.co/600x400/cccccc/333333?text=Image+Not+Available'">
                <div id="preview-modal-thumbnails" class="flex gap-2 pb-2 overflow-x-auto">
                    <!-- Thumbnails -->
                </div>
            </div>
        </div>
    </div>

    <!-- 刪除確認 Modal -->
    <div id="delete-confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/3 text-center">
            <h3 class="text-xl font-bold mb-4">確定刪除？</h3>
            <p id="delete-confirm-text" class="text-gray-600 mb-6">您確定要刪除這個商品嗎？此操作無法復原。</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                <button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">確認刪除</button>
            </div>
        </div>
    </div>


    <!-- 步驟 1: 透過 CDN 引入 Firebase SDK (使用 -compat 版本) -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <!-- 如果需要其他服務，請在此引入對應的 -compat 模組 -->

     <!-- 步驟 2: 放置你的 Firebase 配置和初始化程式碼 -->
    <script>
        // 你的 Firebase 配置物件 (從 Firebase 控制台取得並貼到這裡)
        const firebaseConfig = {
          apiKey: "AIzaSyB7JlDaqB3dm9hpuXrLmxHNr9lBKDznkD0",
          authDomain: "iris-wear.firebaseapp.com",
          projectId: "iris-wear",
          storageBucket: "iris-wear.firebasestorage.app",
          messagingSenderId: "720824939218",
          appId: "1:720824939218:web:13594d0ff6954ee726330b",
          measurementId: "G-53QJG70PJT"
        };

        // 初始化 Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase 初始化成功！");
        } catch (error) {
            console.error("Firebase 初始化失敗：", error);
            // 如果初始化失敗，阻止後續操作
            document.body.innerHTML = '<div class="text-center p-12 text-red-600">Firebase 初始化失敗，請檢查控制台錯誤訊息和配置。</div>';
            throw new Error("Firebase initialization failed"); // 拋出錯誤停止執行
        }


        // 取得 Firestore 實例
        const db = firebase.firestore();
        const productsCollection = db.collection('products'); // 指定商品存放的 collection 名稱
        console.log("Firestore 實例已取得，collection 名稱為 'products'");

    </script>

    <script>
        // --- 資料管理 (改為與 Firestore 互動) ---
        let productIdToDelete = null; // 用於儲存待刪除商品的 Firestore document ID
        let currentProductsData = []; // 新增一個變數來儲存目前的商品資料 (用於編輯/刪除時查找名稱)


        // --- DOM 元素 ---\
        const adminProductList = document.getElementById('admin-product-list');
        const addForm = document.getElementById('add-product-form');

        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-product-form');
        const cancelEditBtn = document.getElementById('cancel-edit');

        const imagePreviewModal = document.getElementById('image-preview-modal');
        const previewModalCloseButton = document.getElementById('preview-modal-close-button');

        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        // --- 核心功能函式 ---

        /**
         * 渲染後台商品列表
         * @param {Array<Object>} products - 從 Firestore 取得的商品資料陣列 (包含 Firestore document ID)
         */
        function renderAdminList(products) {
            console.log("開始渲染商品列表，共", products.length, "項商品。");
            adminProductList.innerHTML = '';
            if (products.length === 0) {
                adminProductList.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">目前沒有商品</td></tr>';
                return;
            }

            products.forEach(product => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'hover:bg-gray-50');
                // 使用 product.id (Firestore document ID) 作為 data-id
                row.innerHTML = `
                    <td class="p-4 flex items-center space-x-3">
                        <img src="${product.imageUrls && product.imageUrls.length > 0 ? product.imageUrls[0] : 'https://placehold.co/48x48/cccccc/333333?text=N/A'}" class="w-12 h-12 rounded-md object-cover" onerror="this.src='https://placehold.co/48x48/cccccc/333333?text=Img'">
                        <span class="font-medium">${product.name || '無名稱'}</span>
                    </td>
                    <td class="p-4 text-gray-600">${product.sku || '無 SKU'}</td>
                    <td class="p-4 text-gray-600">NT$ ${product.price !== undefined ? product.price.toLocaleString() : 'N/A'}</td>
                    <td class="p-4 text-gray-600">${product.stock !== undefined ? product.stock : 'N/A'}</td>
                    <td class="p-4">
                        ${product.is_featured ? '<span class="bg-indigo-100 text-indigo-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">熱門</span>' : ''}
                        ${product.stock > 0 ? '<span class="bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">現貨</span>' : '<span class="bg-red-100 text-red-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">售完</span>'}
                    </td>
                    <td class="p-4 text-center">
                        <button class="text-blue-600 hover:text-blue-800 p-2 view-images-btn" data-id="${product.id}" title="檢視圖片"><i class="fas fa-eye"></i></button>
                        <button class="text-indigo-600 hover:text-indigo-800 p-2 edit-btn" data-id="${product.id}" title="編輯"><i class="fas fa-edit"></i></button>
                        <button class="text-red-600 hover:text-red-800 p-2 delete-btn" data-id="${product.id}" title="刪除"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                adminProductList.appendChild(row);
            });

            addAdminButtonListeners(); // 重新綁定按鈕事件
        }

        function addAdminButtonListeners() {
            // 移除舊的事件監聽器 (避免重複綁定，尤其是在 onSnapshot 更新時)
            document.querySelectorAll('.view-images-btn').forEach(button => {
                // 先檢查是否有監聽器，避免重複移除導致錯誤 (雖然 removeEventListener 處理了)
                // button.removeEventListener('click', handleViewImages); // 這裡其實不需要手動移除，因為每次渲染都會替換整個 tbody
            });
             document.querySelectorAll('.edit-btn').forEach(button => {
                 // button.removeEventListener('click', handleEdit);
             });
             document.querySelectorAll('.delete-btn').forEach(button => {
                 // button.removeEventListener('click', handleDelete);
             });


            // 綁定新的事件監聽器 (因為 tbody 內容被 renderAdminList 完全替換，所以需要重新綁定)
            document.querySelectorAll('.view-images-btn').forEach(button => {
                button.addEventListener('click', handleViewImages);
            });
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', handleEdit);
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDelete);
            });
             console.log("商品列表按鈕事件監聽器已綁定。");
        }


        // --- 事件處理函式 (與 Firestore 互動) ---

        async function handleAdd(e) {
            e.preventDefault();
            console.log("handleAdd triggered");

            const imageUrlsText = document.getElementById('product-image-urls').value;
            const imageUrls = imageUrlsText.split('\\n').map(url => url.trim()).filter(url => url);
            console.log("Parsed Image URLs:", imageUrls);

            const newProductData = {
                name: document.getElementById('product-name').value,
                sku: document.getElementById('product-sku').value,
                price: parseFloat(document.getElementById('product-price').value),
                stock: parseInt(document.getElementById('product-stock').value),
                imageUrls: imageUrls,
                description: document.getElementById('product-description').value,
                is_featured: document.getElementById('product-is-featured').checked,
                createdAt: firebase.firestore.FieldValue.serverTimestamp() // 記錄建立時間
            };

            console.log("Attempting to add product data:", newProductData);

            try {
                // 將新商品資料加入 Firestore
                const docRef = await productsCollection.add(newProductData);
                console.log("商品新增成功！Firestore document ID:", docRef.id);
                alert("商品新增成功！"); // 新增成功提示
                addForm.reset(); // 清空表單
            } catch (error) {
                console.error("新增商品時發生錯誤：", error);
                // 顯示更詳細的錯誤給使用者
                alert("新增商品失敗，請檢查控制台是否有錯誤訊息。\n錯誤：" + error.message);
            }
        }

        async function handleEdit(e) {
            const id = e.currentTarget.dataset.id; // Firestore document ID 是字串
            console.log("Edit button clicked for ID:", id);
            try {
                const doc = await productsCollection.doc(id).get();
                if (doc.exists) {
                    const productToEdit = doc.data();
                     console.log("Fetched product data for editing:", productToEdit);
                    document.getElementById('edit-product-id').value = doc.id; // 儲存 document ID
                    document.getElementById('edit-product-name').value = productToEdit.name || ''; // 處理 undefined
                    document.getElementById('edit-product-sku').value = productToEdit.sku || ''; // 處理 undefined
                    document.getElementById('edit-product-price').value = productToEdit.price !== undefined ? productToEdit.price : ''; // 處理 undefined
                    document.getElementById('edit-product-stock').value = productToEdit.stock !== undefined ? productToEdit.stock : ''; // 處理 undefined
                    document.getElementById('edit-product-image-urls').value = productToEdit.imageUrls && Array.isArray(productToEdit.imageUrls) ? productToEdit.imageUrls.join('\\n') : ''; // 處理 imageUrls 和 undefined
                    document.getElementById('edit-product-description').value = productToEdit.description || ''; // 處理 undefined
                    document.getElementById('edit-product-is-featured').checked = productToEdit.is_featured || false; // 處理 undefined

                    editModal.classList.add('is-open');
                     console.log("Edit modal opened.");
                } else {
                    console.error("找不到該商品文件！ID:", id);
                    alert("找不到該商品，可能已被刪除。");
                }
            } catch (error) {
                console.error("讀取商品資料時發生錯誤：", error);
                alert("讀取商品資料失敗，請檢查控制台。");
            }
        }

         function handleViewImages(e) {
            const id = e.currentTarget.dataset.id; // Firestore document ID 是字串
            console.log("View images button clicked for ID:", id);
             // 從目前的商品列表中找到對應的商品
            const product = currentProductsData.find(p => p.id === id); // 使用全域變數 currentProductsData

            if (!product || !product.imageUrls || product.imageUrls.length === 0) {
                alert('此商品沒有圖片可供預覽。');
                console.warn("No images found for product ID:", id);
                return;
            }
            console.log("Opening image preview modal for product:", product.name);
            openPreviewModal(product);
        }


        async function handleSaveEdit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-product-id').value; // 取得 document ID
             console.log("handleSaveEdit triggered for ID:", id);

            const imageUrlsText = document.getElementById('edit-product-image-urls').value;
            const imageUrls = imageUrlsText.split('\\n').map(url => url.trim()).filter(url => url);
             console.log("Parsed updated Image URLs:", imageUrls);


            const updatedProductData = {
                name: document.getElementById('edit-product-name').value,
                sku: document.getElementById('edit-product-sku').value,
                price: parseFloat(document.getElementById('edit-product-price').value),
                stock: parseInt(document.getElementById('edit-product-stock').value),
                imageUrls: imageUrls,
                description: document.getElementById('edit-product-description').value,
                is_featured: document.getElementById('edit-product-is-featured').checked,
                 updatedAt: firebase.firestore.FieldValue.serverTimestamp() // 記錄更新時間
            };

            console.log("Attempting to update product data for ID", id, ":", updatedProductData);

            try {
                // 更新 Firestore 中的商品文件
                await productsCollection.doc(id).update(updatedProductData);
                console.log("商品更新成功！Document ID:", id);
                 alert("商品更新成功！"); // 新增成功提示
                closeEdit