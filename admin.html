<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iris 後台管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8f9fa;
            display: none; /* 預設隱藏 body，直到認證成功才顯示 */
        }
        .modal {
            display: none;
            transition: opacity 0.3s ease;
        }
        .modal.is-open {
            display: flex;
        }
        /* 圖片預覽 Modal 的樣式 */
        .thumbnail-active {
            border-color: #4f46e5; /* indigo-600 */
            outline: 2px solid #4f46e5; /* 添加外框以更明顯 */
            outline-offset: 2px;
        }

        /* 讓表格頭部固定 */
        .table-container {
            max-height: calc(100vh - 250px); /* 根據實際佈局調整高度 */
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: #f3f4f6; /* bg-gray-100 */
            z-index: 10; /* 確保在滾動時在內容之上 */
        }
    </style>
</head>
<body>
    <header class="bg-white shadow-md sticky top-0 z-40">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-gray-800">
                <a href="#">Iris<span class="text-indigo-600">代購</span> 後台</a>
            </div>
            <div class="flex items-center space-x-4">
                <a href="index.html" target="_blank" class="text-blue-600 hover:text-blue-800 font-semibold">
                    <i class="fas fa-store mr-1"></i>前往前台網站
                </a>
                <button id="logout-button" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300">
                    <i class="fas fa-sign-out-alt mr-1"></i>登出
                </button>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-8">商品管理</h1>

        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">新增商品</h2>
            <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="add-name" class="block text-gray-700 text-sm font-bold mb-2">商品名稱:</label>
                    <input type="text" id="add-name" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="add-category" class="block text-gray-700 text-sm font-bold mb-2">分類:</label>
                    <select id="add-category" name="category" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="">請選擇分類</option>
                        <option value="耳環">耳環</option>
                        <option value="項鍊">項鍊</option>
                        <option value="手鍊">手鍊</option>
                        <option value="戒指">戒指</option>
                        <option value="配件">配件</option>
                    </select>
                </div>
                <div>
                    <label for="add-price" class="block text-gray-700 text-sm font-bold mb-2">價格:</label>
                    <input type="number" id="add-price" name="price" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required min="0">
                </div>
                <div>
                    <label for="add-image-url" class="block text-gray-700 text-sm font-bold mb-2">圖片 URL (多個請用逗號分隔):</label>
                    <input type="text" id="add-image-url" name="image_url" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="例如: url1,url2,url3">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="add-description" class="block text-gray-700 text-sm font-bold mb-2">描述:</label>
                    <textarea id="add-description" name="description" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>
                <div class="col-span-1 md:col-span-2 flex items-center">
                    <input type="checkbox" id="add-is-discontinued" name="is_discontinued" class="mr-2 leading-tight">
                    <label for="add-is-discontinued" class="text-gray-700 text-sm font-bold">已停售</label>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">新增商品</button>
                </div>
            </form>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">現有商品</h2>

            <div class="flex flex-wrap items-center justify-between mb-4 gap-4">
                <div class="flex-grow">
                    <label for="search-input" class="sr-only">搜尋商品:</label>
                    <input type="text" id="search-input" placeholder="搜尋商品名稱或描述..." class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="items-per-page-selector" class="mr-2 text-gray-700 text-sm font-bold">每頁顯示:</label>
                    <select id="items-per-page-selector" class="shadow border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>

            <div class="table-container">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">名稱</th>
                            <th class="py-2 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">分類</th>
                            <th class="py-2 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">價格</th>
                            <th class="py-2 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">圖片</th>
                            <th class="py-2 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">描述</th>
                            <th class="py-2 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">停售</th>
                            <th class="py-2 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="product-list">
                        <tr>
                            <td colspan="7" class="text-center py-4 text-gray-500">載入中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="pagination-controls" class="flex justify-center items-center mt-6 space-x-2">
                </div>
        </div>
    </main>

    <div id="edit-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-8 shadow-xl w-full max-w-2xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">編輯商品</h2>
            <form id="edit-product-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="edit-id" name="id">
                <div>
                    <label for="edit-name" class="block text-gray-700 text-sm font-bold mb-2">商品名稱:</label>
                    <input type="text" id="edit-name" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="edit-category" class="block text-gray-700 text-sm font-bold mb-2">分類:</label>
                    <select id="edit-category" name="category" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="耳環">耳環</option>
                        <option value="項鍊">項鍊</option>
                        <option value="手鍊">手鍊</option>
                        <option value="戒指">戒指</option>
                        <option value="配件">配件</option>
                    </select>
                </div>
                <div>
                    <label for="edit-price" class="block text-gray-700 text-sm font-bold mb-2">價格:</label>
                    <input type="number" id="edit-price" name="price" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required min="0">
                </div>
                <div>
                    <label for="edit-image-url" class="block text-gray-700 text-sm font-bold mb-2">圖片 URL (多個請用逗號分隔):</label>
                    <input type="text" id="edit-image-url" name="image_url" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="例如: url1,url2,url3">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="edit-description" class="block text-gray-700 text-sm font-bold mb-2">描述:</label>
                    <textarea id="edit-description" name="description" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>
                <div class="col-span-1 md:col-span-2 flex items-center">
                    <input type="checkbox" id="edit-is-discontinued" name="is_discontinued" class="mr-2 leading-tight">
                    <label for="edit-is-discontinued" class="text-gray-700 text-sm font-bold">已停售</label>
                </div>
                <div class="col-span-1 md:col-span-2 flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-edit" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">取消</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">儲存變更</button>
                </div>
            </form>
        </div>
    </div>

    <div id="image-preview-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-8 shadow-xl w-full max-w-3xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">商品圖片預覽</h2>
                <button id="preview-modal-close-button" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
            </div>
            <div id="main-image-display" class="w-full h-80 bg-gray-200 flex items-center justify-center rounded-lg mb-4 overflow-hidden">
                <img src="" alt="主要預覽圖" class="max-w-full max-h-full object-contain" id="current-main-image">
            </div>
            <div id="thumbnail-gallery" class="flex flex-wrap justify-center gap-2">
                </div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-8 shadow-xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">確認刪除</h2>
            <p class="text-gray-700 mb-6">您確定要刪除這項商品嗎？此操作無法復原。</p>
            <p class="text-lg font-semibold text-gray-900 mb-6" id="delete-product-name">商品名稱</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">取消</button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">確認刪除</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script>
        // 您的 Firebase 配置物件 (從 Firebase 控制台取得並貼到這裡)
        // !!! 請將這裡的 apiKey 替換為您自己的 Firebase 專案的 apiKey !!!
        const firebaseConfig = {
          apiKey: "AIzaSyB7JlDaqB3dm9hpuXrLmxHNr9lBKDznkD0",
          authDomain: "iris-wear.firebaseapp.com",
          projectId: "iris-wear",
          storageBucket: "iris-wear.firebasestorage.app",
          messagingSenderId: "720824939218",
          appId: "1:720824939218:web:13594d0ff6954ee726330b",
          measurementId: "G-53QJG70PJT"
        };

        // 初始化 Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase 初始化成功！");
        } catch (error) {
            console.error("Firebase 初始化失敗：", error);
            // 如果初始化失敗，阻止後續操作
            document.body.innerHTML = '<div class="text-center p-12 text-red-600">Firebase 初始化失敗，請檢查控制台錯誤訊息和配置。</div>';
            throw new Error("Firebase initialization failed");
        }

        // 取得 Firestore 實例
        const db = firebase.firestore();
        const productsCollection = db.collection('products'); // 指定商品存放的 collection 名稱
        console.log("Firestore 實例已取得，collection 名稱為 'products'");

        // 取得 Auth 實例
        const auth = firebase.auth();
        console.log("Firebase Auth 實例已取得");


        // === 全域或共用的變數 ===
        // 儲存從 Firestore 載入的所有商品資料 (原始完整列表)
        let productsArray = [];
        // 儲存應用搜尋過濾後的商品資料 (分頁將基於此列表)
        let currentFilteredProducts = [];
        // 目前所在的頁碼，從 1 開始
        let currentPage = 1;
        // 每頁顯示的商品數量 - 改為 let
        let itemsPerPage = 10; // 預設值，與 HTML select 中的 selected option 對應

        // --- 資料管理 (改為與 Firestore 互動) ---
        // 這些變數可以在 DOMContentLoaded 外部宣告，因為它們是全域變數
        let productIdToDelete = null; // 用於儲存待刪除商品的 Firestore document ID
        let currentProductsData = []; // 新增一個變數來儲存目前的商品資料 (用於編輯/刪除時查找名稱)


        // !!! 新增 Firebase 認證檢查 !!!
        // 這個檢查應該在 DOMContentLoaded 外部，以確保在頁面內容加載前就進行跳轉
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("使用者已登入，電子郵件:", user.email);
                // 使用者已登入，允許頁面正常載入
                document.body.style.display = 'block'; // 顯示 body 內容
            } else {
                console.log("沒有使用者登入，重新導向到登入頁面。");
                window.location.href = 'login.html'; // 重新導向到您的登入頁面
            }
        });
        // !!! 認證檢查結束 !!!


        // --- 初始化和事件綁定 ---

        // 在 DOM 完全載入後執行
        document.addEventListener('DOMContentLoaded', () => {
          console.log("DOMContentLoaded 觸發，開始綁定事件...");

          // 獲取登出按鈕
          const logoutButton = document.getElementById('logout-button');
          if (logoutButton) {
              logoutButton.addEventListener('click', async () => {
                  try {
                      await auth.signOut();
                      console.log("使用者已登出！");
                      window.location.href = 'login.html'; // 登出後重新導向登入頁面
                  } catch (error) {
                      console.error("登出失敗：", error);
                      alert("登出失敗，請重試。");
                  }
              });
              console.log("登出按鈕事件已綁定。");
          } else {
              console.warn("找不到 ID 為 'logout-button' 的元素。");
          }


          // --- DOM 元素 (在 DOMContentLoaded 內取得確保元素存在) ---
          const productListContainer = document.getElementById('product-list');
          const addForm = document.getElementById('add-product-form');
          const editModal = document.getElementById('edit-modal');
          const editForm = document.getElementById('edit-product-form');
          const cancelEditBtn = document.getElementById('cancel-edit');
          const imagePreviewModal = document.getElementById('image-preview-modal');
          const previewModalCloseButton = document.getElementById('preview-modal-close-button');
          const deleteConfirmModal = document.getElementById('delete-confirm-modal');
          let confirmDeleteBtn = document.getElementById('confirm-delete-btn');
          const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
          const searchInput = document.getElementById('search-input'); // 搜尋輸入框
          const itemsPerPageSelector = document.getElementById('items-per-page-selector'); // 每頁顯示數量選擇器
          const paginationControls = document.getElementById('pagination-controls'); // 分頁控制項容器

          // 檢查是否取得所有必要的 DOM 元素
          if (!productListContainer || !addForm || !editModal || !editForm || !cancelEditBtn || !imagePreviewModal || !previewModalCloseButton || !deleteConfirmModal || !confirmDeleteBtn || !cancelDeleteBtn || !searchInput || !itemsPerPageSelector || !paginationControls) {
              console.error("無法取得部分必要的 DOM 元素，部分功能可能無法運作。");
              console.log({ productListContainer, addForm, editModal, editForm, cancelEditBtn, imagePreviewModal, previewModalCloseButton, deleteConfirmModal, confirmDeleteBtn, cancelDeleteBtn, searchInput, itemsPerPageSelector, paginationControls });
          }


          // === Firebase Firestore 即時監聽 ===
          // 當 Firestore 數據變化時，自動更新頁面顯示
          productsCollection.onSnapshot(snapshot => {
             console.log("Firestore 快照更新，共", snapshot.docs.length, "個文件。");
             const products = snapshot.docs.map(doc => ({
                id: doc.id, // 將 Firestore document ID 加入資料物件
                ...doc.data()
             }));
             // 儲存從 Firestore 載入的所有商品資料 (原始完整列表)
             // 後台顯示所有商品，所以這裡不執行 is_discontinued 過濾
             productsArray = products;
             console.log("載入所有商品，包含停售商品，數量:", productsArray.length);

            // 3. 初始化 currentFilteredProducts 為完整的列表
            // 在這裡應用搜尋過濾 (如果搜尋框有值)
            const searchValue = searchInput.value.toLowerCase();
            if (searchValue) {
                currentFilteredProducts = productsArray.filter(product =>
                    product.name.toLowerCase().includes(searchValue) ||
                    (product.description && product.description.toLowerCase().includes(searchValue))
                );
            } else {
                currentFilteredProducts = [...productsArray];
            }


            // 4. 初始化 currentPage 和 itemsPerPage (itemsPerPage 已經在全域宣告時初始化)
            // 保持當前頁碼，除非當前頁碼超出新數據範圍
            const totalPages = Math.ceil(currentFilteredProducts.length / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages; // 如果當前頁超出範圍，則跳到最後一頁
            } else if (totalPages === 0) {
                currentPage = 1; // 如果沒有數據，則回到第一頁
            }


            // 5. === 初次渲染商品列表 (顯示第一頁的所有商品) ===
            // 呼叫 renderPaginatedList 來顯示第一頁的內容和分頁控制項 (它會使用預設的 itemsPerPage)
            renderPaginatedList(currentFilteredProducts);

            // 6. === 在這裡呼叫 addSearchFunctionality() 和 addItemsPerPageSelectorListener() ===
            // 確保在 productsArray 填充並初次渲染後才呼叫
            // 這些只需要綁定一次，所以只在 DOMContentLoaded 中調用
            // addSearchFunctionality(); // 已經在 DOMContentLoaded 綁定過了
            // addItemsPerPageSelectorListener(); // 已經在 DOMContentLoaded 綁定過了


         }, error => {
             console.error("監聽 Firestore 變化時發生錯誤：", error);
             alert("無法載入商品資料，請檢查網路連線或 Firebase 設定。");
         });


          // === 事件綁定 ===

          // 新增商品表單提交
          addForm.addEventListener('submit', handleAdd);

          // 編輯彈窗取消按鈕
          cancelEditBtn.addEventListener('click', () => {
              editModal.classList.remove('is-open');
          });

          // 編輯商品表單提交
          editForm.addEventListener('submit', handleSaveEdit);

          // 圖片預覽 Modal 關閉按鈕
          previewModalCloseButton.addEventListener('click', () => {
              imagePreviewModal.classList.remove('is-open');
          });

          // 刪除確認 Modal 取消按鈕
          cancelDeleteBtn.addEventListener('click', () => {
              deleteConfirmModal.classList.remove('is-open');
              productIdToDelete = null; // 清除待刪除的商品ID
          });

          // 刪除確認 Modal 確認按鈕 (重新綁定，確保正確)
          // 移除舊的事件監聽器以避免重複
          if (confirmDeleteBtn) {
              const oldConfirmDeleteBtn = confirmDeleteBtn;
              confirmDeleteBtn = oldConfirmDeleteBtn.cloneNode(true); // 複製節點以移除所有事件監聽器
              oldConfirmDeleteBtn.parentNode.replaceChild(confirmDeleteBtn, oldConfirmDeleteBtn); // 替換舊節點
          } else {
              console.warn("找不到 ID 為 'confirm-delete-btn' 的元素，無法綁定刪除確認事件。");
          }
          if (confirmDeleteBtn) {
              confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
          }


          // 搜尋功能事件監聽
          searchInput.addEventListener('input', () => {
              const searchValue = searchInput.value.toLowerCase();
              currentFilteredProducts = productsArray.filter(product =>
                  product.name.toLowerCase().includes(searchValue) ||
                  (product.description && product.description.toLowerCase().includes(searchValue))
              );
              currentPage = 1; // 搜尋後回到第一頁
              renderPaginatedList(currentFilteredProducts);
          });

          // 每頁顯示數量選擇器事件監聽
          itemsPerPageSelector.addEventListener('change', (event) => {
              itemsPerPage = parseInt(event.target.value);
              currentPage = 1; // 改變每頁數量後回到第一頁
              renderPaginatedList(currentFilteredProducts);
          });

          // 分頁按鈕點擊事件監聽器 (委派)
          paginationControls.addEventListener('click', (event) => {
              if (event.target.tagName === 'BUTTON' && event.target.dataset.page) {
                  currentPage = parseInt(event.target.dataset.page);
                  renderPaginatedList(currentFilteredProducts);
              }
          });

          // 商品列表內的編輯/刪除/圖片按鈕事件監聽器 (委派)
          productListContainer.addEventListener('click', (event) => {
              const target = event.target;
              // 檢查點擊是否來自按鈕或其子圖標
              const button = target.closest('button');

              if (button) {
                  const action = button.dataset.action;
                  const productId = button.dataset.id;
                  const product = productsArray.find(p => p.id === productId); // 從原始資料找商品

                  if (!product) {
                      console.error(`找不到 ID 為 ${productId} 的商品。`);
                      return;
                  }

                  if (action === 'edit') {
                      handleEdit(product);
                  } else if (action === 'delete') {
                      handleDelete(product);
                  } else if (action === 'view-images') {
                      handleViewImages(product);
                  }
              }
          });

        }); // DOMContentLoaded 結束


        // === 輔助函數 ===

        // 渲染商品列表 (分頁後)
        function renderPaginatedList(productsToRender) {
            productListContainer.innerHTML = ''; // 清空現有內容

            if (productsToRender.length === 0) {
                productListContainer.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500">${searchInput.value ? '查無符合條件的商品。' : '目前沒有任何商品。'}</td></tr>`;
                renderPaginationControls(0, 0); // 清空分頁控制項
                return;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedProducts = productsToRender.slice(startIndex, endIndex);

            paginatedProducts.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200';
                row.innerHTML = `
                    <td class="py-3 px-4">${product.name}</td>
                    <td class="py-3 px-4">${product.category}</td>
                    <td class="py-3 px-4">$${product.price}</td>
                    <td class="py-3 px-4">
                        ${product.image_url && product.image_url.length > 0 ?
                            `<button data-action="view-images" data-id="${product.id}" class="text-blue-500 hover:underline"><i class="fas fa-images mr-1"></i>預覽 (${product.image_url.length})</button>` :
                            '無圖片'
                        }
                    </td>
                    <td class="py-3 px-4 text-sm text-gray-600">${product.description ? product.description.substring(0, 50) + (product.description.length > 50 ? '...' : '') : '無描述'}</td>
                    <td class="py-3 px-4">
                        <input type="checkbox" ${product.is_discontinued ? 'checked' : ''} disabled class="form-checkbox h-4 w-4 text-indigo-600">
                    </td>
                    <td class="py-3 px-4 whitespace-nowrap">
                        <button data-action="edit" data-id="${product.id}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md mr-2 text-sm">
                            <i class="fas fa-edit mr-1"></i>編輯
                        </button>
                        <button data-action="delete" data-id="${product.id}" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-sm">
                            <i class="fas fa-trash-alt mr-1"></i>刪除
                        </button>
                    </td>
                `;
                productListContainer.appendChild(row);
            });

            renderPaginationControls(productsToRender.length, itemsPerPage);
        }

        // 渲染分頁控制項
        function renderPaginationControls(totalItems, itemsPerPage) {
            const paginationControls = document.getElementById('pagination-controls');
            if (!paginationControls) {
                console.error("找不到 ID 為 'pagination-controls' 的元素。");
                return;
            }
            paginationControls.innerHTML = ''; // 清空現有分頁按鈕

            const totalPages = Math.ceil(totalItems / itemsPerPage);

            if (totalPages <= 1) {
                // 如果只有一頁或沒有資料，不顯示分頁控制項
                return;
            }

            // 上一頁按鈕
            const prevButton = document.createElement('button');
            prevButton.textContent = '上一頁';
            prevButton.className = `px-3 py-1 rounded-md border ${currentPage === 1 ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white text-indigo-600 border-indigo-600 hover:bg-indigo-50'}`;
            prevButton.disabled = currentPage === 1;
            prevButton.dataset.page = currentPage - 1;
            paginationControls.appendChild(prevButton);

            // 頁碼按鈕
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = `px-3 py-1 rounded-md border ${currentPage === i ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-100'}`;
                pageButton.dataset.page = i;
                paginationControls.appendChild(pageButton);
            }

            // 下一頁按鈕
            const nextButton = document.createElement('button');
            nextButton.textContent = '下一頁';
            nextButton.className = `px-3 py-1 rounded-md border ${currentPage === totalPages ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white text-indigo-600 border-indigo-600 hover:bg-indigo-50'}`;
            nextButton.disabled = currentPage === totalPages;
            nextButton.dataset.page = currentPage + 1;
            paginationControls.appendChild(nextButton);
        }

        // === CRUD 操作函數 ===

        // 處理新增商品
        async function handleAdd(event) {
            event.preventDefault();
            const addForm = event.target;
            const newProduct = {
                name: addForm['name'].value,
                category: addForm['category'].value,
                price: parseFloat(addForm['price'].value),
                image_url: addForm['image_url'].value.split(',').map(url => url.trim()).filter(url => url), // 分割並清理 URL
                description: addForm['description'].value,
                is_discontinued: addForm['is_discontinued'].checked
            };

            try {
                await productsCollection.add(newProduct);
                alert('商品新增成功！');
                addForm.reset(); // 清空表單
            } catch (error) {
                console.error("新增商品失敗：", error);
                alert('新增商品失敗：' + error.message);
            }
        }

        // 處理編輯商品 (開啟 Modal 並填充數據)
        function handleEdit(product) {
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-product-form');

            // 填充表單
            editForm['edit-id'].value = product.id;
            editForm['edit-name'].value = product.name;
            editForm['edit-category'].value = product.category;
            editForm['edit-price'].value = product.price;
            editForm['edit-image-url'].value = product.image_url ? product.image_url.join(',') : '';
            editForm['edit-description'].value = product.description || '';
            editForm['edit-is-discontinued'].checked = product.is_discontinued;

            editModal.classList.add('is-open'); // 顯示 Modal
        }

        // 處理儲存編輯後的商品
        async function handleSaveEdit(event) {
            event.preventDefault();
            const editForm = event.target;
            const productId = editForm['edit-id'].value;
            const updatedProduct = {
                name: editForm['edit-name'].value,
                category: editForm['edit-category'].value,
                price: parseFloat(editForm['edit-price'].value),
                image_url: editForm['edit-image-url'].value.split(',').map(url => url.trim()).filter(url => url),
                description: editForm['edit-description'].value,
                is_discontinued: editForm['edit-is-discontinued'].checked
            };

            try {
                await productsCollection.doc(productId).update(updatedProduct);
                alert('商品更新成功！');
                document.getElementById('edit-modal').classList.remove('is-open'); // 關閉 Modal
            } catch (error) {
                console.error("更新商品失敗：", error);
                alert('更新商品失敗：' + error.message);
            }
        }

        // 處理刪除商品 (開啟確認 Modal)
        function handleDelete(product) {
            productIdToDelete = product.id; // 儲存要刪除的商品 ID
            const deleteProductName = document.getElementById('delete-product-name');
            deleteProductName.textContent = product.name; // 顯示商品名稱
            document.getElementById('delete-confirm-modal').classList.add('is-open'); // 顯示確認 Modal
        }

        // 處理確認刪除商品
        async function handleConfirmDelete() {
            if (productIdToDelete) {
                try {
                    await productsCollection.doc(productIdToDelete).delete();
                    alert('商品刪除成功！');
                    document.getElementById('delete-confirm-modal').classList.remove('is-open'); // 關閉確認 Modal
                    productIdToDelete = null; // 清除 ID
                } catch (error) {
                    console.error("刪除商品失敗：", error);
                    alert('刪除商品失敗：' + error.message);
                }
            }
        }

        // 處理圖片預覽
        function handleViewImages(product) {
            const imagePreviewModal = document.getElementById('image-preview-modal');
            const mainImageDisplay = document.getElementById('current-main-image');
            const thumbnailGallery = document.getElementById('thumbnail-gallery');

            thumbnailGallery.innerHTML = ''; // 清空縮圖

            if (!product.image_url || product.image_url.length === 0) {
                mainImageDisplay.src = '';
                mainImageDisplay.alt = '無圖片';
                thumbnailGallery.innerHTML = '<p class="text-gray-500">此商品沒有圖片。</p>';
                imagePreviewModal.classList.add('is-open');
                return;
            }

            // 設定第一張圖為預設顯示圖
            mainImageDisplay.src = product.image_url[0];
            mainImageDisplay.alt = product.name;

            // 建立縮圖
            product.image_url.forEach((url, index) => {
                const img = document.createElement('img');
                img.src = url;
                img.alt = `商品縮圖 ${index + 1}`;
                img.className = `w-20 h-20 object-cover rounded-md cursor-pointer border-2 border-transparent transition-all duration-200 ${index === 0 ? 'thumbnail-active' : ''}`;
                img.addEventListener('click', () => {
                    mainImageDisplay.src = url;
                    // 移除所有縮圖的 active 樣式
                    Array.from(thumbnailGallery.children).forEach(thumb => {
                        thumb.classList.remove('thumbnail-active');
                    });
                    // 為當前點擊的縮圖添加 active 樣式
                    img.classList.add('thumbnail-active');
                });
                thumbnailGallery.appendChild(img);
            });

            imagePreviewModal.classList.add('is-open');
        }

    </script>
</body>
</html>